x-healthcheck: &healthcheck
  interval: 10s
  timeout: 5s
  retries: 10
  start_period: 5s
  start_interval: 5s

x-toolbox: &toolbox
  image: us-central1-docker.pkg.dev/database-toolbox/toolbox/toolbox:0.13.0
  healthcheck:
    <<: *healthcheck
    test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]

services:
  postgres:
    image: postgres:17.6-trixie
    ports:
      - 5432:5432
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    healthcheck:
      <<: *healthcheck
      test: [ "CMD", "pg_isready", "-U", "postgres" ]
    networks:
      - postgres

  postgres-toolbox:
    <<: *toolbox
    ports:
      - 5001:5000
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    command: [ "toolbox", "--address", "0.0.0.0", "--ui", "--prebuilt", "postgres" ]
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - postgres

  mssql:
    image: mcr.microsoft.com/mssql/server:2025-latest
    platform: linux/amd64
    ports:
      - 1433:1433
    environment:
      SA_PASSWORD: Password123!
      ACCEPT_EULA: Y
    healthcheck:
      <<: *healthcheck
      test: [ "CMD", "/opt/mssql-tools18/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "Password123!", "-Q", "SELECT 1", "-C" ]
    networks:
      - mssql

  mssql-toolbox:
    <<: *toolbox
    ports:
      - 5002:5000
    environment:
      MSSQL_HOST: mssql
      MSSQL_PORT: 1433
      MSSQL_DATABASE: msdb
      MSSQL_USER: sa
      MSSQL_PASSWORD: Password123!
    command: [ "toolbox", "--address", "0.0.0.0", "--ui", "--prebuilt", "mssql" ]
    depends_on:
      mssql:
        condition: service_healthy
    networks:
      - mssql

  oracle:
    image: gvenzl/oracle-free:23.9-slim-faststart
    ports:
      - 1521:1521
    environment:
      ORACLE_PASSWORD: password
      APP_USER: app_user
      APP_USER_PASSWORD: password
    healthcheck:
      <<: *healthcheck
      test: [ "CMD", "healthcheck.sh" ]
    networks:
      - oracle

  oracle-sqlcl:
    image: container-registry.oracle.com/database/sqlcl:25.2.2
    volumes:
      - ./docker/oracle-sqlcl:/opt/oracle/sql_scripts:ro
    depends_on:
      oracle:
        condition: service_healthy
    networks:
      - oracle
    # Save connection for MCP server, then keep container running
    entrypoint: >
      sh -c "cd /opt/oracle/sql_scripts && sql /nolog @connect.sql && tail -f /dev/null"

networks:
  postgres:
    internal: true
  mssql:
    internal: true
  oracle:
    internal: true
